<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ユーザー情報編集</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .error-message {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      margin-top: 0.25rem;
      font-size: 0.875rem;
      color: #ef4444;
    }
    .success-message {
      animation: fadeIn 0.3s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .danger-zone {
      border: 2px solid #dc2626;
      background: linear-gradient(to bottom, #fef2f2, #ffffff);
    }
  </style>
</head>
<body class="bg-gray-50">
  <div class="min-h-screen py-8 px-4">
    <div class="max-w-2xl mx-auto space-y-6">
      <!-- メイン編集セクション -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <h1 class="text-2xl font-bold text-gray-800 mb-6">
          ユーザー情報編集
        </h1>

        <!-- ローディング表示 -->
        <div id="loadingMessage" class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-md">
          <div class="text-blue-600 text-sm">データを読み込み中...</div>
        </div>

        <!-- 成功メッセージ -->
        <div id="successMessage" class="hidden mb-4 p-4 bg-green-50 border border-green-200 rounded-md success-message">
          <div class="text-green-600 text-sm">ユーザー情報を更新しました</div>
        </div>

        <!-- エラーメッセージ -->
        <div id="errorMessage" class="hidden mb-4 p-4 bg-red-50 border border-red-200 rounded-md">
          <div class="text-red-600 text-sm"></div>
        </div>

        <!-- フォーム -->
        <div id="formContainer" class="space-y-5" style="display: none;">
          <!-- 名前 -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              名前 <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="name"
              maxlength="10"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
            <div id="nameError" class="error-message hidden">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
              </svg>
              <span></span>
            </div>
          </div>

          <!-- メールアドレス -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              メールアドレス <span class="text-red-500">*</span>
            </label>
            <input
              type="email"
              id="email"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
            <div id="emailError" class="error-message hidden">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
              </svg>
              <span></span>
            </div>
          </div>

          <!-- 年齢（自動計算・変更不可） -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              年齢
              <span class="ml-2 text-xs text-gray-400 font-normal">（誕生日から自動計算）</span>
            </label>
            <div
              id="age"
              class="w-full px-3 py-2 border border-gray-200 rounded-md bg-gray-50 text-gray-500 cursor-not-allowed"
            >—</div>
          </div>

          <!-- 誕生日（変更不可・表示のみ） -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              誕生日
              <span class="ml-2 text-xs text-gray-400 font-normal">（変更不可）</span>
            </label>
            <div
              id="birthdate"
              class="w-full px-3 py-2 border border-gray-200 rounded-md bg-gray-50 text-gray-500 cursor-not-allowed"
            >—</div>
          </div>

          <!-- パスワード変更セクション -->
          <div class="pt-4 border-t border-gray-200">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">
              パスワード変更(変更する場合のみ入力)
            </h2>

            <div class="space-y-4">
              <!-- 新しいパスワード -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  新しいパスワード
                </label>
                <input
                  type="password"
                  id="password"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
                <div id="passwordError" class="error-message hidden">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                  </svg>
                  <span></span>
                </div>
              </div>

              <!-- パスワード確認 -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  パスワード確認
                </label>
                <input
                  type="password"
                  id="confirmPassword"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
                <div id="confirmPasswordError" class="error-message hidden">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                  </svg>
                  <span></span>
                </div>
              </div>
            </div>
          </div>

          <!-- ボタン -->
          <div class="flex gap-3 pt-4">
            <button
              id="saveBtn"
              class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 disabled:bg-blue-400 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2"
            >
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                <polyline points="7 3 7 8 15 8"></polyline>
              </svg>
              <span>保存</span>
            </button>
            <button
              id="cancelBtn"
              class="flex-1 bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300 transition-colors flex items-center justify-center gap-2"
            >
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
              <span>キャンセル</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Danger Zone -->
      <div id="dangerZone" class="danger-zone rounded-lg shadow-md p-6" style="display: none;">
        <div class="flex items-center gap-2 mb-4">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
            <line x1="12" y1="9" x2="12" y2="13"></line>
            <line x1="12" y1="17" x2="12.01" y2="17"></line>
          </svg>
          <h2 class="text-xl font-bold text-red-600">Danger Zone</h2>
        </div>
        
        <div class="bg-white rounded-md p-4 border border-red-200">
          <h3 class="font-semibold text-gray-800 mb-2">アカウントの削除</h3>
          <p class="text-sm text-gray-600 mb-4">
            アカウントを削除すると、すべてのデータが完全に削除されます。この操作は取り消せません。
          </p>
          
          <button
            id="deleteAccountBtn"
            class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 transition-colors flex items-center gap-2"
          >
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
              <line x1="10" y1="11" x2="10" y2="17"></line>
              <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
            <span>アカウントを削除</span>
          </button>
        </div>
      </div>

      <!-- 注意事項 -->
      <div class="p-4 bg-blue-50 border border-blue-200 rounded-md">
        <p class="text-sm text-blue-800">
          <strong>使い方:</strong>
        </p>
        <ul class="text-sm text-blue-700 mt-2 space-y-1 ml-4 list-disc">
          <li>ログイン中のユーザー情報を編集できます</li>
          <li>未ログインの場合、自動的にログインページへリダイレクトされます</li>
          <li>パスワードは変更する場合のみ入力してください</li>
          <li>年齢は誕生日から自動計算されます。誕生日を迎えると自動で更新されます</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- 削除確認モーダル -->
  <div id="deleteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6">
      <div class="flex items-center gap-3 mb-4">
        <div class="bg-red-100 p-2 rounded-full">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
            <line x1="12" y1="9" x2="12" y2="13"></line>
            <line x1="12" y1="17" x2="12.01" y2="17"></line>
          </svg>
        </div>
        <h3 class="text-xl font-bold text-gray-900">アカウントの削除</h3>
      </div>
      
      <p class="text-gray-700 mb-4">
        本当にアカウントを削除しますか?この操作は取り消せません。
      </p>
      
      <div class="bg-red-50 border border-red-200 rounded-md p-3 mb-4">
        <p class="text-sm text-red-800 font-medium">削除されるデータ:</p>
        <ul class="text-sm text-red-700 mt-1 ml-4 list-disc">
          <li>ユーザー情報</li>
          <li>お気に入りスポット</li>
          <li>すべての関連データ</li>
        </ul>
      </div>
      
      <div class="flex gap-3">
        <button
          id="confirmDeleteBtn"
          class="flex-1 bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 transition-colors font-medium"
        >
          削除する
        </button>
        <button
          id="cancelDeleteBtn"
          class="flex-1 bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300 transition-colors font-medium"
        >
          キャンセル
        </button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE_URL = '/api';
    let currentUserId = null;

    // フォーム要素の取得
    const nameInput = document.getElementById('name');
    const emailInput = document.getElementById('email');
    const ageDisplay = document.getElementById('age');
    const birthdateDisplay = document.getElementById('birthdate');
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    const saveBtn = document.getElementById('saveBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');
    const loadingMessage = document.getElementById('loadingMessage');
    const formContainer = document.getElementById('formContainer');
    const dangerZone = document.getElementById('dangerZone');

    // 削除関連要素
    const deleteAccountBtn = document.getElementById('deleteAccountBtn');
    const deleteModal = document.getElementById('deleteModal');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');

    // エラー要素の取得
    const nameError = document.getElementById('nameError');
    const emailError = document.getElementById('emailError');
    const passwordError = document.getElementById('passwordError');
    const confirmPasswordError = document.getElementById('confirmPasswordError');

    // エラーメッセージ表示
    function showApiError(message) {
      errorMessage.querySelector('div').textContent = message;
      errorMessage.classList.remove('hidden');
    }

    // エラーメッセージ非表示
    function hideApiError() {
      errorMessage.classList.add('hidden');
    }

    // ログインチェックとユーザーデータの読み込み
    async function loadUserData() {
      try {
        hideApiError();
        loadingMessage.classList.remove('hidden');
        formContainer.style.display = 'none';
        dangerZone.style.display = 'none';

        const checkResponse = await fetch(`${API_BASE_URL}/check-session`, {
          method: 'GET',
          credentials: 'same-origin'
        });

        if (!checkResponse.ok) {
          window.location.href = '/';
          return;
        }

        const sessionData = await checkResponse.json();
        
        if (!sessionData.logged_in || !sessionData.user_id) {
          window.location.href = '/';
          return;
        }

        currentUserId = sessionData.user_id;

        const response = await fetch(`${API_BASE_URL}/users/${sessionData.user_id}`, {
          credentials: 'same-origin'
        });
        
        if (!response.ok) {
          throw new Error(`ユーザーデータの取得に失敗しました (${response.status})`);
        }

        const user = await response.json();
        
        nameInput.value = user.name || '';
        emailInput.value = user.email || '';
        // 年齢は読み取り専用表示
        ageDisplay.textContent = user.age != null ? user.age + '歳' : '—';
        // 誕生日は読み取り専用表示
        if (user.birthdate) {
          const bd = new Date(user.birthdate);
          birthdateDisplay.textContent = `${bd.getFullYear()}年${bd.getMonth()+1}月${bd.getDate()}日`;
        } else {
          birthdateDisplay.textContent = '未登録';
        }

        loadingMessage.classList.add('hidden');
        formContainer.style.display = 'block';
        dangerZone.style.display = 'block';

      } catch (error) {
        console.error('データ取得エラー:', error);
        loadingMessage.classList.add('hidden');
        showApiError('ユーザーデータの読み込みに失敗しました: ' + error.message);
      }
    }

    // エラー表示
    function showError(errorElement, message) {
      errorElement.querySelector('span').textContent = message;
      errorElement.classList.remove('hidden');
      errorElement.previousElementSibling.classList.add('border-red-500');
    }

    // エラークリア
    function clearError(errorElement) {
      errorElement.classList.add('hidden');
      errorElement.previousElementSibling.classList.remove('border-red-500');
    }

    // 全エラークリア
    function clearAllErrors() {
      clearError(nameError);
      clearError(emailError);
      clearError(passwordError);
      clearError(confirmPasswordError);
    }

    // バリデーション
    function validateForm() {
      clearAllErrors();
      let isValid = true;

      if (!nameInput.value.trim()) {
        showError(nameError, '名前を入力してください');
        isValid = false;
      } else if (nameInput.value.length > 10) {
        showError(nameError, '名前は10文字以内で入力してください');
        isValid = false;
      }

      if (!emailInput.value.trim()) {
        showError(emailError, 'メールアドレスを入力してください');
        isValid = false;
      } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailInput.value)) {
        showError(emailError, '有効なメールアドレスを入力してください');
        isValid = false;
      }

      if (passwordInput.value && passwordInput.value.length < 8) {
        showError(passwordError, 'パスワードは8文字以上で入力してください');
        isValid = false;
      }

      if (passwordInput.value && passwordInput.value !== confirmPasswordInput.value) {
        showError(confirmPasswordError, 'パスワードが一致しません');
        isValid = false;
      }

      return isValid;
    }

    // 入力時のエラークリア
    [nameInput, emailInput, passwordInput, confirmPasswordInput].forEach(input => {
      input.addEventListener('input', function() {
        const errorId = this.id + 'Error';
        const errorElement = document.getElementById(errorId);
        if (errorElement) {
          clearError(errorElement);
        }
        hideApiError();
      });
    });

    // 保存ボタンのクリックイベント
    saveBtn.addEventListener('click', async function() {
      if (!validateForm()) {
        return;
      }

      hideApiError();
      saveBtn.disabled = true;
      saveBtn.querySelector('span').textContent = '保存中...';

      const userData = {
        name: nameInput.value,
        email: emailInput.value,
        // age は送信しない（サーバー側でbirthdateから自動計算）
      };

      if (passwordInput.value) {
        userData.password = passwordInput.value;
      }

      try {
        const checkResponse = await fetch(`${API_BASE_URL}/check-session`, {
          method: 'GET',
          credentials: 'same-origin'
        });

        if (!checkResponse.ok) {
          throw new Error('セッションの確認に失敗しました');
        }

        const sessionData = await checkResponse.json();
        
        if (!sessionData.logged_in || !sessionData.user_id) {
          window.location.href = '/';
          return;
        }

        const response = await fetch(`${API_BASE_URL}/users/${sessionData.user_id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'same-origin',
          body: JSON.stringify(userData)
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'ユーザー情報の更新に失敗しました');
        }

        successMessage.classList.remove('hidden');
        
        passwordInput.value = '';
        confirmPasswordInput.value = '';

        setTimeout(() => {
          successMessage.classList.add('hidden');
        }, 3000);

      } catch (error) {
        console.error('保存エラー:', error);
        showApiError('保存に失敗しました: ' + error.message);
      } finally {
        saveBtn.disabled = false;
        saveBtn.querySelector('span').textContent = '保存';
      }
    });

    // キャンセルボタンのクリックイベント
    cancelBtn.addEventListener('click', function() {
      window.history.back();
    });

    // アカウント削除ボタン
    deleteAccountBtn.addEventListener('click', function() {
      deleteModal.classList.remove('hidden');
    });

    // 削除キャンセル
    cancelDeleteBtn.addEventListener('click', function() {
      deleteModal.classList.add('hidden');
    });

    // モーダル外クリックで閉じる
    deleteModal.addEventListener('click', function(e) {
      if (e.target === deleteModal) {
        deleteModal.classList.add('hidden');
      }
    });

    // 削除確定
    confirmDeleteBtn.addEventListener('click', async function() {
      try {
        confirmDeleteBtn.disabled = true;
        confirmDeleteBtn.textContent = '削除中...';

        const response = await fetch(`${API_BASE_URL}/users/${currentUserId}`, {
          method: 'DELETE',
          credentials: 'same-origin'
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'アカウントの削除に失敗しました');
        }

        // 削除成功 - ログインページへリダイレクト
        alert('アカウントを削除しました');
        window.location.href = '/';

      } catch (error) {
        console.error('削除エラー:', error);
        alert('削除に失敗しました: ' + error.message);
        confirmDeleteBtn.disabled = false;
        confirmDeleteBtn.textContent = '削除する';
      }
    });

    // ページ読み込み時にユーザーデータを取得
    loadUserData();
  </script>
</body>
</html>