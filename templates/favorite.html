<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãŠæ°—ã«å…¥ã‚Šã®å ´æ‰€ - æ—…è¡Œãƒ—ãƒ©ãƒ³ã‚µãƒ¼ãƒ“ã‚¹</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/static/css/favorites.css">
  
</head>
<body class="bg-gradient-to-br from-blue-500 via-purple-500 to-pink-500 min-h-screen">
  <div class="py-8 px-4">
    <div class="max-w-7xl mx-auto">
      <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
      <div class="bg-white bg-opacity-10 backdrop-blur-md rounded-lg shadow-lg p-6 mb-6">
        <div class="flex justify-between items-center">
          <button onclick="location.href='index.html'" class="bg-white text-purple-600 px-4 py-2 rounded-lg font-bold hover:bg-gray-100 transition-all">
            â† æˆ»ã‚‹
          </button>
          <h1 class="text-3xl font-bold text-white">â­ ãŠæ°—ã«å…¥ã‚Šã®å ´æ‰€</h1>
          <div class="w-20"></div>
        </div>
      </div>

      <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
      <div id="loadingMessage" class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
        <div class="text-blue-600 text-sm">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>

      <!-- æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
      <div id="successMessage" class="hidden mb-4 p-4 bg-green-50 border border-green-200 rounded-lg success-message">
        <div class="text-green-600 text-sm font-medium">ãŠæ°—ã«å…¥ã‚Šã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸ</div>
      </div>

      <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
      <div id="errorMessage" class="hidden mb-4 p-4 bg-red-50 border border-red-200 rounded-lg">
        <div class="text-red-600 text-sm font-medium"></div>
      </div>

      <!-- çµ±è¨ˆã‚«ãƒ¼ãƒ‰ -->
      <div id="statsCard" class="hidden bg-white rounded-lg shadow-lg p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">ãŠæ°—ã«å…¥ã‚Šçµ±è¨ˆ</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="bg-gradient-to-r from-blue-500 to-purple-500 text-white p-6 rounded-lg text-center">
            <div class="text-4xl font-bold mb-2" id="total-count">0</div>
            <div class="text-sm opacity-90">ç™»éŒ²ã‚¹ãƒãƒƒãƒˆ</div>
          </div>
          <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white p-6 rounded-lg text-center">
            <div class="text-4xl font-bold mb-2" id="type-count">0</div>
            <div class="text-sm opacity-90">ã‚«ãƒ†ã‚´ãƒªãƒ¼</div>
          </div>
          <div class="bg-gradient-to-r from-pink-500 to-red-500 text-white p-6 rounded-lg text-center">
            <div class="text-4xl font-bold mb-2" id="latest-date">---</div>
            <div class="text-sm opacity-90">æœ€æ–°ç™»éŒ²æ—¥</div>
          </div>
        </div>
      </div>

      <!-- ãŠæ°—ã«å…¥ã‚Šä¸€è¦§ã‚³ãƒ³ãƒ†ãƒŠ -->
      <div id="favoritesContainer"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const API_BASE_URL = '/api';
    let favorites = [];

    // DOMè¦ç´ 
    const loadingMessage = document.getElementById('loadingMessage');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');
    const statsCard = document.getElementById('statsCard');
    const favoritesContainer = document.getElementById('favoritesContainer');

    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    function showApiError(message) {
      errorMessage.querySelector('div').textContent = message;
      errorMessage.classList.remove('hidden');
      setTimeout(() => {
        errorMessage.classList.add('hidden');
      }, 5000);
    }

    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸éè¡¨ç¤º
    function hideApiError() {
      errorMessage.classList.add('hidden');
    }

    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    function showSuccessMessage(message) {
      successMessage.querySelector('div').textContent = message;
      successMessage.classList.remove('hidden');
      setTimeout(() => {
        successMessage.classList.add('hidden');
      }, 3000);
    }

    // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ç¢ºèª
    async function checkLoginStatus() {
      try {
        const response = await fetch(`${API_BASE_URL}/check-login`, {
          credentials: 'include'
        });
        const data = await response.json();
        return data.logged_in;
      } catch (error) {
        console.error('ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
        return false;
      }
    }

    // ãŠæ°—ã«å…¥ã‚Šä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
    async function loadFavorites() {
      try {
        hideApiError();
        loadingMessage.classList.remove('hidden');
        statsCard.classList.add('hidden');
        favoritesContainer.innerHTML = '';

        const response = await fetch(`${API_BASE_URL}/favorites`, {
          credentials: 'include'
        });

        if (!response.ok) {
          throw new Error(`ãŠæ°—ã«å…¥ã‚Šã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ (${response.status})`);
        }

        const data = await response.json();

        if (data.success) {
          favorites = data.favorites;
          updateStats();
          displayFavorites();
          loadingMessage.classList.add('hidden');
          statsCard.classList.remove('hidden');
        } else {
          throw new Error(data.message || 'ãŠæ°—ã«å…¥ã‚Šã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      } catch (error) {
        console.error('ãŠæ°—ã«å…¥ã‚Šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        loadingMessage.classList.add('hidden');
        showApiError('ãŠæ°—ã«å…¥ã‚Šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
    function updateStats() {
      document.getElementById('total-count').textContent = favorites.length;

      // ã‚«ãƒ†ã‚´ãƒªãƒ¼æ•°ã‚’è¨ˆç®—
      const types = new Set(favorites.map(f => f.spot_type).filter(Boolean));
      document.getElementById('type-count').textContent = types.size;

      // æœ€æ–°ç™»éŒ²æ—¥
      if (favorites.length > 0) {
        const latestDate = new Date(favorites[0].created_at);
        const month = latestDate.getMonth() + 1;
        const day = latestDate.getDate();
        document.getElementById('latest-date').textContent = `${month}/${day}`;
      } else {
        document.getElementById('latest-date').textContent = '---';
      }
    }

    // ãŠæ°—ã«å…¥ã‚Šã‚’è¡¨ç¤º
    function displayFavorites() {
      if (favorites.length === 0) {
        favoritesContainer.innerHTML = `
          <div class="bg-white rounded-lg shadow-lg p-12 text-center">
            <div class="empty-icon mb-6">â­</div>
            <h2 class="text-2xl font-bold text-gray-800 mb-3">ãŠæ°—ã«å…¥ã‚ŠãŒã‚ã‚Šã¾ã›ã‚“</h2>
            <p class="text-gray-600 mb-6">
              åœ°å›³ã‹ã‚‰ã‚¹ãƒãƒƒãƒˆã‚’æ¢ã—ã¦<br>
              ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼
            </p>
            <a href="map.html" class="inline-block bg-gradient-to-r from-blue-500 to-purple-500 text-white px-8 py-3 rounded-lg font-bold hover:shadow-lg transition-all">
              ğŸ—ºï¸ åœ°å›³ã‚’è¦‹ã‚‹
            </a>
          </div>
        `;
        return;
      }

      let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">';

      favorites.forEach(fav => {
        const date = new Date(fav.created_at).toLocaleDateString('ja-JP', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });

        html += `
          <div class="favorite-card bg-white rounded-lg shadow-lg overflow-hidden">
            ${fav.spot_lat && fav.spot_lon ? `
              <div class="mini-map" id="map-${fav.osm_id}"></div>
            ` : ''}
            
            <div class="p-5">
              <div class="mb-3">
                <h3 class="text-lg font-bold text-gray-800 mb-2">${fav.spot_name}</h3>
                <span class="inline-block bg-gradient-to-r from-blue-500 to-purple-500 text-white text-xs px-3 py-1 rounded-full">
                  ${fav.spot_type || 'ã‚¹ãƒãƒƒãƒˆ'}
                </span>
              </div>

              ${fav.address ? `
                <div class="text-sm text-gray-600 mb-3">
                  ğŸ“ ${fav.address}
                </div>
              ` : ''}

              ${fav.memo ? `
                <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-700 mb-3">
                  ğŸ’­ ${fav.memo}
                </div>
              ` : ''}

              <div class="text-xs text-gray-500 mb-4">
                ğŸ“… ç™»éŒ²æ—¥: ${date}
              </div>

              <div class="flex gap-2">
                <button onclick="viewOnMap(${fav.osm_id}, ${fav.spot_lat}, ${fav.spot_lon})" 
                        class="btn-map flex-1 bg-gradient-to-r from-blue-500 to-purple-500 text-white py-2 px-4 rounded-lg font-medium hover:shadow-lg transition-all">
                  ğŸ—ºï¸ åœ°å›³ã§è¦‹ã‚‹
                </button>
                <button onclick="removeFavorite(${fav.osm_id})" 
                        class="btn-delete bg-red-500 text-white py-2 px-4 rounded-lg font-medium hover:bg-red-600 transition-all">
                  ğŸ—‘ï¸
                </button>
              </div>
            </div>
          </div>
        `;
      });

      html += '</div>';
      favoritesContainer.innerHTML = html;

      // ãƒŸãƒ‹ãƒãƒƒãƒ—ã‚’åˆæœŸåŒ–
      setTimeout(() => {
        favorites.forEach(fav => {
          if (fav.spot_lat && fav.spot_lon) {
            initMiniMap(fav.osm_id, fav.spot_lat, fav.spot_lon);
          }
        });
      }, 100);
    }

    // ãƒŸãƒ‹ãƒãƒƒãƒ—ã‚’åˆæœŸåŒ–
    function initMiniMap(osmId, lat, lon) {
      const mapElement = document.getElementById(`map-${osmId}`);
      if (!mapElement) return;

      try {
        const miniMap = L.map(mapElement, {
          zoomControl: false,
          dragging: false,
          scrollWheelZoom: false,
          doubleClickZoom: false,
          touchZoom: false,
          attributionControl: false
        }).setView([lat, lon], 14);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: 'Â© OpenStreetMap'
        }).addTo(miniMap);

        L.marker([lat, lon]).addTo(miniMap);
      } catch (error) {
        console.error('ãƒŸãƒ‹ãƒãƒƒãƒ—åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // åœ°å›³ã§è¡¨ç¤º
    function viewOnMap(osmId, lat, lon) {
      window.location.href = `map.html?osm_id=${osmId}&lat=${lat}&lon=${lon}&zoom=15`;
    }

    // ãŠæ°—ã«å…¥ã‚Šã‚’å‰Šé™¤
    async function removeFavorite(osmId) {
      if (!confirm('ã“ã®ãŠæ°—ã«å…¥ã‚Šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

      try {
        const response = await fetch(`${API_BASE_URL}/favorites/spot/${osmId}`, {
          method: 'DELETE',
          credentials: 'include'
        });

        if (!response.ok) {
          throw new Error(`å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ (${response.status})`);
        }

        const data = await response.json();

        if (data.success) {
          showSuccessMessage('ãŠæ°—ã«å…¥ã‚Šã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸ');
          await loadFavorites();
        } else {
          throw new Error(data.message || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      } catch (error) {
        console.error('ãŠæ°—ã«å…¥ã‚Šå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        showApiError('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
    window.addEventListener('load', async function() {
      const isLoggedIn = await checkLoginStatus();

      if (!isLoggedIn) {
        alert('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
        window.location.href = 'login.html?redirect=favorites.html';
        return;
      }

      await loadFavorites();
    });
  </script>
</body>
</html>
